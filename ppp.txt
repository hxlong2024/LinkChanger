import streamlit as st
import sqlite3
import os
import time
import uuid
import threading
import datetime
import extra_streamlit_components as stx
from datetime import datetime, timedelta, timezone
import httpx
import requests
import re
import random
import string
import html
from urllib.parse import quote
from retrying import retry

# ==========================================
# 0. æ•°æ®åº“ç®¡ç† (è‡ªåŠ¨è¿ç§»ç‰ˆ)
# ==========================================
DB_FILE = "linkchanger.db"

class DBManager:
    def __init__(self):
        self._init_db()
        self._migrate_db()

    def _get_conn(self):
        return sqlite3.connect(DB_FILE, check_same_thread=False)

    def _init_db(self):
        conn = self._get_conn()
        c = conn.cursor()
        c.execute('''CREATE TABLE IF NOT EXISTS users (
                        uid TEXT PRIMARY KEY,
                        name TEXT,
                        pin TEXT,
                        wechat TEXT,
                        q_cookie TEXT,
                        b_cookie TEXT,
                        q_img TEXT,
                        b_img TEXT,
                        b_pwd TEXT,
                        bark TEXT,
                        pushdeer TEXT,
                        created_at TEXT
                    )''')
        conn.commit()
        conn.close()

    def _migrate_db(self):
        conn = self._get_conn()
        c = conn.cursor()
        try:
            c.execute("SELECT bark FROM users LIMIT 1")
        except sqlite3.OperationalError:
            try:
                c.execute("ALTER TABLE users ADD COLUMN bark TEXT DEFAULT ''")
                c.execute("ALTER TABLE users ADD COLUMN pushdeer TEXT DEFAULT ''")
                conn.commit()
                print("æ•°æ®åº“å·²å‡çº§ï¼šæ·»åŠ  bark/pushdeer å­—æ®µ")
            except Exception as e:
                print(f"æ•°æ®åº“è¿ç§»å¤±è´¥: {e}")
        finally:
            conn.close()

    def add_user(self, uid, name, pin, wechat):
        conn = self._get_conn()
        c = conn.cursor()
        try:
            created_at = datetime.now().strftime("%Y-%m-%d %H:%M")
            c.execute("""INSERT INTO users 
                         (uid, name, pin, wechat, q_cookie, b_cookie, q_img, b_img, b_pwd, bark, pushdeer, created_at) 
                         VALUES (?, ?, ?, ?, '', '', '', '', '', '', '', ?)""",
                      (uid, name, pin, wechat, created_at))
            conn.commit()
            return True, "æ·»åŠ æˆåŠŸ"
        except sqlite3.IntegrityError:
            return False, "UID å·²å­˜åœ¨ï¼Œè¯·æ¢ä¸€ä¸ª"
        except Exception as e:
            return False, f"æ•°æ®åº“é”™è¯¯: {e}"
        finally:
            conn.close()

    def get_user(self, uid):
        conn = self._get_conn()
        c = conn.cursor()
        c.execute("SELECT * FROM users WHERE uid=?", (uid,))
        row = c.fetchone()
        conn.close()
        if row:
            return {
                "uid": row[0], "name": row[1], "pin": row[2], "wechat": row[3],
                "q": row[4], "b": row[5], 
                "q_img": row[6], "b_img": row[7], "b_pwd": row[8],
                "bark": row[9], "pushdeer": row[10]
            }
        return None

    def get_all_users(self):
        conn = self._get_conn()
        c = conn.cursor()
        c.execute("SELECT uid, name, wechat, created_at, q_cookie, b_cookie FROM users")
        rows = c.fetchall()
        conn.close()
        return rows 

    def update_user_profile(self, uid, data_dict):
        conn = self._get_conn()
        c = conn.cursor()
        c.execute('''UPDATE users SET 
                     name=?, pin=?, q_cookie=?, b_cookie=?, 
                     q_img=?, b_img=?, b_pwd=?,
                     bark=?, pushdeer=?
                     WHERE uid=?''', 
                  (data_dict['name'], data_dict['pin'], data_dict['q'], data_dict['b'], 
                   data_dict['q_img'], data_dict['b_img'], data_dict['b_pwd'],
                   data_dict['bark'], data_dict['pushdeer'],
                   uid))
        conn.commit()
        conn.close()

    def delete_user(self, uid):
        conn = self._get_conn()
        c = conn.cursor()
        c.execute("DELETE FROM users WHERE uid=?", (uid,))
        conn.commit()
        conn.close()

db = DBManager()

# ==========================================
# 1. æ ¸å¿ƒ Engine ä¸ Worker (å ä½ç¬¦)
# ==========================================
# ğŸ”´ğŸ”´ğŸ”´ è¯·åŠ¡å¿…å°†ä½ ä¹‹å‰çœŸå®å¥½ç”¨çš„ QuarkEngine å’Œ BaiduEngine ä»£ç è´´åœ¨è¿™é‡Œ ğŸ”´ğŸ”´ğŸ”´
# ğŸ”´ğŸ”´ğŸ”´ ä¸‹é¢æ˜¯ Mock ä»£ç ï¼Œå¦‚æœä¸æ›¿æ¢ï¼Œæ— æ³•çœŸæ­£è½¬å­˜ ğŸ”´ğŸ”´ğŸ”´

# --- Mock ä»£ç å¼€å§‹ ---
def get_time_diff(t): return "1s"
def smart_shorten_url(t): return t
def create_copy_button_html(t): return ""
def extract_smart_folder_name(t, s): return "Res"
def sanitize_filename(n): return n
def send_notification(b, p, t, bo): pass 

@st.cache_resource
class JobManager:
    def __init__(self): self.jobs = {}
    def create_job(self): 
        jid = str(uuid.uuid4())[:8]
        self.jobs[jid] = {"status": "running", "logs": [], "result_text": "", "progress": {"current":0,"total":0}, "created_at": datetime.now(), "summary": {}}
        return jid
    def get_job(self, jid): return self.jobs.get(jid)
    def add_log(self, jid, msg, type="info"): 
        if jid in self.jobs: self.jobs[jid]["logs"].append({"time": "00:00", "msg": msg, "type": type})
    def complete_job(self, jid, text, sum): 
        if jid in self.jobs: 
            self.jobs[jid]["status"]="done"; self.jobs[jid]["result_text"]=text; self.jobs[jid]["summary"]=sum
    def update_progress(self, jid, c, t):
        if jid in self.jobs: self.jobs[jid]["progress"] = {"current": c, "total": t}
job_manager = JobManager()

def worker_thread(job_id, input_text, q_c, b_c, bark, push, img_conf):
    time.sleep(1)
    job_manager.complete_job(job_id, input_text + "\n(æµ‹è¯•å®Œæˆ)", {"success": 1, "total": 1, "duration": "1s"})
# --- Mock ä»£ç ç»“æŸ ---


# ==========================================
# 2. UI ç»„ä»¶ä¸å·¥å…·å‡½æ•°
# ==========================================
st.set_page_config(page_title="LinkChanger Pro", page_icon="âš¡", layout="wide")

# ğŸ”¥ğŸ”¥ğŸ”¥ æ ¸å¿ƒä¿®å¤ç‚¹ï¼šä½¿ç”¨ @st.cache_resource ä¸”ä¸å¸¦å‚æ•° ğŸ”¥ğŸ”¥ğŸ”¥
@st.cache_resource
def get_manager():
    return stx.CookieManager()

def check_login_status(uid):
    """
    ä¼˜å…ˆæŸ¥ Session -> å…¶æ¬¡æŸ¥ Cookie -> æ¢å¤ Session
    """
    session_key = f"auth_{uid}"
    
    # 1. Session å‘½ä¸­
    if st.session_state.get(session_key):
        return True
    
    # 2. Cookie å‘½ä¸­
    try:
        cookie_manager = get_manager()
        cookie_val = cookie_manager.get(session_key)
        if cookie_val == "logged_in":
            st.session_state[session_key] = True # æ¢å¤ Session
            return True
    except:
        pass
        
    return False

def render_status_badge(label, is_active):
    color = "#d4edda" if is_active else "#f8d7da"
    text_color = "#155724" if is_active else "#721c24"
    icon = "ğŸŸ¢" if is_active else "ğŸ”´"
    return f"""
    <div style="background-color: {color}; color: {text_color}; padding: 4px 10px; border-radius: 12px; font-size: 12px; display: inline-block; margin-right: 5px; font-weight: bold;">
        {icon} {label}
    </div>
    """

# ==========================================
# 3. é¡µé¢é€»è¾‘ï¼šç®¡ç†å‘˜åå°
# ==========================================
def page_admin():
    st.markdown("### ğŸ›¡ï¸ LinkChanger æ§åˆ¶å°")
    
    ADMIN_PWD = st.secrets.get("general", {}).get("admin_password", "admin888")
    
    if "admin_logged_in" not in st.session_state:
        with st.container(border=True):
            c1, c2 = st.columns([2, 1])
            c1.info("è¯·éªŒè¯ç®¡ç†å‘˜èº«ä»½")
            pwd = c2.text_input("Password", type="password", label_visibility="collapsed", placeholder="è¾“å…¥å¯†ç ")
            if c2.button("éªŒè¯ç™»å½•", type="primary", use_container_width=True):
                if pwd == ADMIN_PWD:
                    st.session_state.admin_logged_in = True
                    st.rerun()
                else:
                    time.sleep(1)
                    st.error("å¯†ç é”™è¯¯")
        return

    users = db.get_all_users()
    col1, col2, col3, col4 = st.columns(4)
    col1.metric("æ³¨å†Œç”¨æˆ·", len(users))
    col2.metric("æœ‰æ•ˆCookie", len([u for u in users if u[4] or u[5]]))
    col3.metric("è¿è¡ŒçŠ¶æ€", "Running")
    if col4.button("é€€å‡ºç®¡ç†"):
        del st.session_state["admin_logged_in"]
        st.rerun()

    st.markdown("---")

    tab1, tab2 = st.tabs(["ğŸ‘¥ ç”¨æˆ·åˆ—è¡¨", "â• æ–°å¢ç”¨æˆ·"])
    
    with tab1:
        if not users:
            st.info("æš‚æ— ç”¨æˆ·")
        else:
            cols = st.columns([2, 2, 2, 3, 1])
            cols[0].markdown("**æ˜µç§°**")
            cols[1].markdown("**UID**")
            cols[2].markdown("**å¾®ä¿¡å·**")
            cols[3].markdown("**é…ç½®çŠ¶æ€**")
            cols[4].markdown("**æ“ä½œ**")
            
            for u in users:
                with st.container(border=True):
                    cols = st.columns([2, 2, 2, 3, 1])
                    cols[0].write(u[1]) # Name
                    cols[1].code(u[0])  # UID
                    cols[2].write(u[2]) # WeChat
                    
                    badges = ""
                    if u[4]: badges += render_status_badge("å¤¸å…‹", True)
                    else: badges += render_status_badge("å¤¸å…‹", False)
                    if u[5]: badges += render_status_badge("ç™¾åº¦", True)
                    else: badges += render_status_badge("ç™¾åº¦", False)
                    cols[3].markdown(badges, unsafe_allow_html=True)
                    
                    if cols[4].button("ğŸ—‘ï¸", key=f"del_{u[0]}"):
                        db.delete_user(u[0])
                        st.toast("å·²åˆ é™¤")
                        time.sleep(1)
                        st.rerun()

    with tab2:
        with st.container(border=True):
            st.markdown("#### åˆ›å»ºæ–°è´¦å·")
            with st.form("add_user"):
                c1, c2 = st.columns(2)
                uid = c1.text_input("UID (ç™»å½•è´¦å·)", placeholder="ä¾‹: vip001")
                name = c2.text_input("ç”¨æˆ·æ˜µç§°", placeholder="ä¾‹: å¼ ä¸‰")
                c3, c4 = st.columns(2)
                wechat = c3.text_input("å¾®ä¿¡å·", placeholder="ä»…è®°å½•")
                pin = c4.text_input("åˆå§‹å¯†ç ", value="123456")
                
                if st.form_submit_button("ç¡®è®¤åˆ›å»º", type="primary", use_container_width=True):
                    if uid and name:
                        ok, msg = db.add_user(uid, name, pin, wechat)
                        if ok:
                            st.success(f"åˆ›å»ºæˆåŠŸï¼å‘é€é“¾æ¥: `?uid={uid}`")
                        else:
                            st.error(msg)
                    else:
                        st.error("è¯·å¡«å†™å®Œæ•´")

# ==========================================
# 4. é¡µé¢é€»è¾‘ï¼šç”¨æˆ·å·¥å…·é¡µ
# ==========================================
def page_user_tool(uid):
    user = db.get_user(uid)
    if not user:
        st.error("è´¦å·å¼‚å¸¸ï¼Œè¯·è”ç³»ç®¡ç†å‘˜")
        return

    with st.sidebar:
        st.header(f"ğŸ‘‹ Hi, {user['name']}")
        st.caption(f"UID: {user['uid']}")
        
        if st.button("ğŸšª å®‰å…¨é€€å‡º", use_container_width=True):
            get_manager().delete(f"auth_{uid}")
            if f"auth_{uid}" in st.session_state:
                del st.session_state[f"auth_{uid}"]
            st.rerun()
            
        st.markdown("---")
        st.markdown("**çŠ¶æ€æ¦‚è§ˆ**")
        st.markdown(render_status_badge("å¤¸å…‹ç½‘ç›˜", bool(user['q'])), unsafe_allow_html=True)
        st.markdown(render_status_badge("ç™¾åº¦ç½‘ç›˜", bool(user['b'])), unsafe_allow_html=True)
        st.markdown(render_status_badge("æ¶ˆæ¯æ¨é€", bool(user['bark'] or user['pushdeer'])), unsafe_allow_html=True)

    tab_task, tab_config = st.tabs(["ğŸš€ è½¬å­˜ä»»åŠ¡", "âš™ï¸ å‚æ•°é…ç½®"])

    with tab_task:
        with st.container(border=True):
            st.markdown("##### ğŸ“ æ–°å»ºä»»åŠ¡")
            input_text = st.text_area("åœ¨æ­¤ç²˜è´´åˆ†äº«é“¾æ¥", height=120, placeholder="æ”¯æŒæ··åˆç²˜è´´ï¼š\nhttps://pan.quark.cn/s/...\nhttps://pan.baidu.com/s/...")
            
            c_run, c_tip = st.columns([1, 3])
            start_btn = c_run.button("ğŸš€ å¼€å§‹è½¬å­˜", type="primary", use_container_width=True)
            c_tip.caption("ğŸ’¡ è‡ªåŠ¨è¯†åˆ«å¤¸å…‹/ç™¾åº¦é“¾æ¥ï¼Œè‡ªåŠ¨å»é‡ï¼Œè‡ªåŠ¨æ¤å…¥å¹¿å‘Šã€‚")
            
            if start_btn:
                if not input_text.strip():
                    st.toast("è¯·å…ˆç²˜è´´é“¾æ¥ï¼", icon="âš ï¸")
                elif not user['q'] and not user['b']:
                    st.error("è¯·å…ˆåœ¨ã€Œå‚æ•°é…ç½®ã€é¡µå¡«å…¥ Cookieï¼")
                else:
                    jid = job_manager.create_job()
                    img_conf = {
                        "quark": {"url": user['q_img'], "enabled": bool(user['q_img'])},
                        "baidu": {"url": user['b_img'], "pwd": user['b_pwd'], "enabled": bool(user['b_img'])}
                    }
                    t = threading.Thread(target=worker_thread, args=(
                        jid, input_text, user['q'], user['b'], 
                        user['bark'], user['pushdeer'], img_conf
                    ))
                    t.start()
                    st.query_params["job_id"] = jid
                    st.query_params["uid"] = uid
                    st.rerun()

        curr_jid = st.query_params.get("job_id")
        if curr_jid:
            job = job_manager.get_job(curr_jid)
            if job:
                st.markdown("##### ğŸ“Š ä»»åŠ¡è¿›åº¦")
                with st.status(f"å½“å‰çŠ¶æ€: {job['status']}", expanded=True) as status:
                    if job['status'] == 'done':
                        status.update(label="âœ… ä»»åŠ¡å·²å®Œæˆ", state="complete")
                        st.success("å¤„ç†å®Œæ¯•ï¼")
                        st.text_area("å¤„ç†ç»“æœ (å¯å¤åˆ¶)", value=job['result_text'], height=150)
                    else:
                        st.info("æ­£åœ¨åŠªåŠ›æ¬è¿ä¸­...")
                    
                    for log in job['logs']:
                        st.text(f"{log['time']} {log['msg']}")
                
                if job['status'] == 'done':
                    if st.button("å¼€å§‹ä¸‹ä¸€æ‰¹"):
                        st.query_params["job_id"] = ""
                        st.query_params["uid"] = uid
                        st.rerun()

    with tab_config:
        with st.form("config_form", border=True):
            st.subheader("ğŸ”§ ä¸ªäººå‚æ•°è®¾ç½®")
            
            st.markdown("###### 1. è´¦å·ä¸å®‰å…¨")
            c1, c2 = st.columns(2)
            u_name = c1.text_input("ç”¨æˆ·æ˜µç§°", value=user['name'])
            u_pin = c2.text_input("ç™»å½•å¯†ç ", value=user['pin'], type="password")
            
            st.markdown("###### 2. ç½‘ç›˜ Cookie (æ ¸å¿ƒ)")
            u_q = st.text_area("å¤¸å…‹ Cookie", value=user['q'], height=80, placeholder="å¡«å…¥ Cookie...")
            u_b = st.text_area("ç™¾åº¦ Cookie", value=user['b'], height=80, placeholder="å¡«å…¥ Cookie...")
            
            st.markdown("###### 3. å¹¿å‘Šæ¤å…¥ (å¯é€‰)")
            c3, c4 = st.columns(2)
            u_q_img = c3.text_input("å¤¸å…‹å¹¿å‘Šé“¾æ¥", value=user['q_img'])
            u_b_img = c4.text_input("ç™¾åº¦å¹¿å‘Šé“¾æ¥", value=user['b_img'])
            u_b_pwd = c4.text_input("ç™¾åº¦æå–ç ", value=user['b_pwd'])
            
            st.markdown("###### 4. æ¶ˆæ¯æ¨é€ (å¯é€‰)")
            c5, c6 = st.columns(2)
            u_bark = c5.text_input("iOS Bark Key", value=user['bark'], placeholder="ä¾‹å¦‚: XQCpH...")
            u_push = c6.text_input("PushDeer Key", value=user['pushdeer'])
            
            if st.form_submit_button("ğŸ’¾ ä¿å­˜æ‰€æœ‰é…ç½®", type="primary", use_container_width=True):
                new_data = user.copy()
                new_data.update({
                    'name': u_name, 'pin': u_pin,
                    'q': u_q, 'b': u_b,
                    'q_img': u_q_img, 'b_img': u_b_img, 'b_pwd': u_b_pwd,
                    'bark': u_bark, 'pushdeer': u_push
                })
                db.update_user_profile(uid, new_data)
                st.toast("é…ç½®å·²ä¿å­˜ï¼", icon="âœ…")
                time.sleep(1)
                st.rerun()

# ==========================================
# 5. ä¸»ç¨‹åºå…¥å£
# ==========================================
def main():
    uid = st.query_params.get("uid", None)
    HIDDEN_ADMIN_UID = st.secrets.get("general", {}).get("admin_uid", "admin_entry_default")

    if not uid:
        st.markdown("<br><br><h2 style='text-align:center'>ğŸš« Access Denied</h2>", unsafe_allow_html=True)
        return

    if uid == HIDDEN_ADMIN_UID:
        page_admin()
        return

    user = db.get_user(uid)
    if not user:
        st.error("æ— æ•ˆçš„ UID")
        return

    if check_login_status(uid):
        page_user_tool(uid)
    else:
        col1, col2, col3 = st.columns([1, 2, 1])
        with col2:
            st.markdown(f"<h3 style='text-align:center'>ğŸ”’ Welcome Back</h3>", unsafe_allow_html=True)
            with st.container(border=True):
                st.write(f"ç”¨æˆ·ï¼š**{user['name']}**")
                pwd = st.text_input("Password", type="password", label_visibility="collapsed", placeholder="è¾“å…¥å¯†ç è§£é”")
                if st.button("è§£é”è¿›å…¥", type="primary", use_container_width=True):
                    if pwd == user['pin']:
                        # å†™ Cookie å¹¶å†™ Session
                        get_manager().set(f"auth_{uid}", "logged_in", expires_at=datetime.now() + timedelta(days=30))
                        st.session_state[f"auth_{uid}"] = True
                        st.rerun()
                    else:
                        st.error("å¯†ç é”™è¯¯")

if __name__ == "__main__":
    main()
